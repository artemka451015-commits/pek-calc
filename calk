// /api/pec/calc.js
export default async function handler(req, res) {
  try {
    if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

    const apiKey = process.env.PEC_API_KEY;
    if (!apiKey) return res.status(500).json({ error: "PEC_API_KEY missing" });

    const { toCity, toZip, weightKg, lengthCm, widthCm, heightCm, mode } = req.body || {};
    if (!weightKg || (!toCity && !toZip)) {
      return res.status(400).json({ error: "Missing required fields" });
    }

    // TODO: сформировать запрос в ПЭК (URL + body) по их API
    const pekResp = await fetch("https://...PEK_API_ENDPOINT...", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": apiKey, // или Bearer/Key — как требует ПЭК
      },
      body: JSON.stringify({
        toCity,
        toZip,
        weightKg,
        lengthCm,
        widthCm,
        heightCm,
        mode, // "terminal" | "door"
      }),
    });

    const data = await pekResp.json();
    if (!pekResp.ok) {
      return res.status(502).json({ error: "PEK error", details: data });
    }

    // TODO: вытащить итоговую цену из ответа ПЭК
    const price = data?.price ?? data?.result?.price;
    const days  = data?.days ?? data?.result?.days;

    if (price == null) return res.status(502).json({ error: "No price in PEK response", raw: data });

    return res.status(200).json({ price, days: days ?? null });
  } catch (e) {
    return res.status(500).json({ error: "Server error", details: String(e?.message || e) });
  }
}
